<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IonosTek Monitor V24.0 (Diagnostic)</title>
    <style>
        body { background: #111; color: #fff; font-family: monospace; padding: 20px; }
        h1 { text-align: center; color: #00e676; }
        
        /* Layout */
        .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .box { background: #222; border: 1px solid #444; padding: 15px; text-align: center; border-radius: 5px; }
        .label { color: #888; font-size: 0.8em; }
        .value { font-size: 1.5em; font-weight: bold; margin-top: 5px; }
        
        /* Debug Box */
        #debug-log { 
            margin-top: 20px; padding: 10px; background: #000; 
            border: 1px solid #ff1744; color: #ff1744; font-size: 0.8em; 
            height: 150px; overflow-y: scroll; white-space: pre-wrap;
        }
        .log-ok { color: #00e676; }
    </style>
</head>
<body>

    <h1>IONOSTEK V24.0 (DIAGNOSTIC)</h1>

    <div class="container">
        <div class="box"><div class="label">Solar Flux (SFI)</div><div class="value" id="v-sfi">--</div></div>
        <div class="box"><div class="label">Sunspot (SSN)</div><div class="value" id="v-ssn">--</div></div>
        <div class="box"><div class="label">Solar Wind</div><div class="value" id="v-wind">--</div></div>
        <div class="box"><div class="label">Bz (Polarity)</div><div class="value" id="v-bz">--</div></div>
        <div class="box"><div class="label">Kp Index</div><div class="value" id="v-kp">--</div></div>
        <div class="box"><div class="label">X-Ray</div><div class="value" id="v-xray">--</div></div>
    </div>

    <h3>SYSTEM LOG (ส่งข้อความในนี้มาให้ผมถ้ายังไม่ทำงาน)</h3>
    <div id="debug-log">System Started... Waiting for data...</div>

    <script>
        function log(msg, type='err') {
            const d = document.getElementById('debug-log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'ok' ? '#00e676' : '#ff1744';
            d.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        function update(id, val) {
            const el = document.getElementById('v-'+id);
            if(el) {
                el.innerText = val;
                el.style.color = '#00e676';
            }
        }

        // --- Core Fetcher ---
        async function fetchData() {
            log("Starting Fetch Sequence...", "ok");

            const proxy = "https://api.allorigins.win/get?url=";
            const ts = "&t=" + Date.now();

            // 1. Test Solar Wind (JSON)
            try {
                const url = "https://services.swpc.noaa.gov/products/solar-wind/mag-5-minute.json";
                log("Fetching Mag...");
                const res = await fetch(proxy + encodeURIComponent(url) + ts);
                const data = await res.json(); // AllOrigins returns JSON wrapper
                
                if (data.contents) {
                    const innerData = JSON.parse(data.contents); // Parse inner NOAA JSON
                    const last = innerData[innerData.length - 1];
                    // Index 1 = Bz, Index 2 = Bt (usually)
                    update('bz', last[1] + " nT");
                    log("Mag Data OK", "ok");
                } else {
                    throw new Error("No contents in proxy response");
                }
            } catch(e) {
                log("Mag Error: " + e.message);
            }

            // 2. Test Plasma (JSON)
            try {
                const url = "https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json";
                log("Fetching Plasma...");
                const res = await fetch(proxy + encodeURIComponent(url) + ts);
                const data = await res.json();
                const innerData = JSON.parse(data.contents);
                const last = innerData[innerData.length - 1];
                // Index 1 = Density, Index 2 = Speed
                update('wind', last[2] + " km/s");
                log("Plasma Data OK", "ok");
            } catch(e) {
                log("Plasma Error: " + e.message);
            }

            // 3. Test SFI (Text File)
            try {
                const url = "https://services.swpc.noaa.gov/text/daily-solar-indices.txt";
                log("Fetching Text SFI...");
                const res = await fetch(proxy + encodeURIComponent(url) + ts);
                const data = await res.json();
                const text = data.contents;
                const lines = text.trim().split('\n');
                
                // Loop from bottom to find data
                let found = false;
                for(let i=lines.length-1; i>=0; i--) {
                    if(lines[i].match(/^\d{4}/)) { // Starts with year
                        const parts = lines[i].trim().split(/\s+/);
                        update('sfi', parts[3]);
                        update('ssn', parts[4]);
                        found = true;
                        log("SFI/SSN OK", "ok");
                        break;
                    }
                }
                if(!found) log("SFI pattern not found");
            } catch(e) {
                log("SFI Error: " + e.message);
            }
            
            // 4. Test Kp (JSON)
             try {
                const url = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json";
                const res = await fetch(proxy + encodeURIComponent(url) + ts);
                const data = await res.json();
                const inner = JSON.parse(data.contents);
                const last = inner[inner.length-1];
                update('kp', last[1]);
                log("Kp Data OK", "ok");
             } catch(e) { log("Kp Error: " + e.message); }

            // 5. X-Ray (6-hour JSON)
            try {
                const url = "https://services.swpc.noaa.gov/products/x-rays-6-hour.json";
                const res = await fetch(proxy + encodeURIComponent(url) + ts);
                const data = await res.json();
                const inner = JSON.parse(data.contents);
                // Find valid flux
                let flux = "N/A";
                for(let i=inner.length-1; i>0; i--) {
                    if(inner[i][3]) { flux = inner[i][3]; break; }
                }
                update('xray', flux);
                log("X-Ray OK", "ok");
            } catch(e) { log("X-Ray Error: " + e.message); }
        }

        // Run once on load
        fetchData();
    </script>
</body>
</html>
