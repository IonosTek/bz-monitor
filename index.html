<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IonosTek Monitor V5.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #0f0f13; --card-bg: #1a1a20; --text-main: #e0e0e0; --accent-green: #00ff9d; --accent-red: #ff4d4d; --accent-yellow: #ffc107; --border-color: #333; }
        body { font-family: 'Chakra Petch', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; }
        h1, h3 { margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        .blink { animation: blinker 1.5s linear infinite; color: red; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        /* Layout Grid */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; max-width: 1400px; margin: 0 auto; }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        /* Top Stats (ปรับให้รองรับ 5 ช่อง) */
        .stats-container { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 20px; }
        .stat-box { background: #252530; padding: 15px; border-radius: 8px; min-width: 160px; border-left: 4px solid #555; flex: 1; text-align: center; max-width: 250px; }
        .stat-value { font-size: 2em; font-weight: bold; margin: 5px 0; }
        .stat-label { font-size: 0.8em; color: #aaa; font-weight: bold; }
        .stat-unit { font-size: 0.7em; color: #666; }
        
        img { width: 100%; height: auto; border-radius: 5px; border: 1px solid #444; display: block; margin: 0 auto; }
        .footer { text-align: center; margin-top: 40px; font-size: 0.8em; color: #666; }
        
        /* Status Colors */
        .status-normal { color: var(--accent-green); border-left-color: var(--accent-green) !important; }
        .status-warn { color: var(--accent-yellow); border-left-color: var(--accent-yellow) !important; }
        .status-alert { color: var(--accent-red); border-left-color: var(--accent-red) !important; }
    </style>
</head>
<body>

    <div class="header">
        <h1>IONOSTEK <span style="color:var(--accent-green)">MONITOR V5.0</span></h1>
        <span>FULL SPECTRUM DASHBOARD • <span class="blink">●</span> ONLINE</span>
        <div id="updateTime" style="font-size: 0.9em; margin-top: 5px; color: #aaa;">Initializing...</div>
    </div>

    <div class="dashboard">
        <div class="stats-container">
            <div class="stat-box" id="card-dst">
                <div class="stat-label">DST (Storm)</div>
                <div class="stat-value" id="val-dst">--</div>
                <div class="stat-unit">nT (Kyoto)</div>
            </div>
            <div class="stat-box" id="card-bt">
                <div class="stat-label">IMF Bt (Total)</div>
                <div class="stat-value" id="val-bt">--</div>
                <div class="stat-unit">nT (Strength)</div>
            </div>
            <div class="stat-box" id="card-bz">
                <div class="stat-label">Bz (Direction)</div>
                <div class="stat-value" id="val-bz">--</div>
                <div class="stat-unit">nT (South Bad)</div>
            </div>
            <div class="stat-box" id="card-density">
                <div class="stat-label">Density</div>
                <div class="stat-value" id="val-density">--</div>
                <div class="stat-unit">p/cm³</div>
            </div>
            <div class="stat-box" id="card-wind">
                <div class="stat-label">Solar Wind</div>
                <div class="stat-value" id="val-wind">--</div>
                <div class="stat-unit">km/s</div>
            </div>
        </div>

        <div class="card">
            <h3>Aurora Forecast</h3>
            <img src="https://services.swpc.noaa.gov/images/aurora-forecast-northern-hemisphere.jpg" id="img-aurora" alt="Aurora">
        </div>
        <div class="card">
            <h3>HF Conditions</h3>
            <img src="https://www.hamqsl.com/solar101vhf.php" id="img-muf" alt="HF Conditions" style="border:none;">
        </div>
        <div class="card">
            <h3>Sun Monitor</h3>
            <img src="https://sdo.gsfc.nasa.gov/assets/img/latest/latest_512_0193.jpg" id="img-sun" alt="Sun">
        </div>
        <div class="card">
            <h3>X-Ray Flux</h3>
            <img src="https://services.swpc.noaa.gov/images/swx-overview-small.gif" id="img-xray" alt="X-Ray">
        </div>
        
        <div class="card" style="grid-column: 1 / -1;">
             <h3>Planetary K-Index (NOAA)</h3>
             <p style="font-size:0.8em; color:#888;">ระดับความรุนแรงพายุ (G-Scale)</p>
             <img src="https://services.swpc.noaa.gov/images/planetary-k-index.png" 
                  id="img-geospace" 
                  alt="Planetary K-Index"
                  onerror="this.src='https://services.swpc.noaa.gov/images/station-k-index.png'">
        </div>
    </div>

    <div class="footer">
        IonosTek Monitor V5.0 • Data: NOAA / Kyoto / HamQSL
    </div>

    <script>
        // 1. Fetch Mag (Bz และ Bt)
        async function fetchMag() {
            try {
                const res = await fetch('https://services.swpc.noaa.gov/products/solar-wind/mag-5-minute.json');
                if (!res.ok) throw new Error('Network');
                const data = await res.json();
                if (data && data.length > 1) {
                    const last = data[data.length - 1];
                    
                    // Bz is index 3
                    const bz = parseFloat(last[3]); 
                    updateStat('val-bz', 'card-bz', bz, 'bz');

                    // Bt (Total) is index 4
                    const bt = parseFloat(last[4]); 
                    updateStat('val-bt', 'card-bt', bt, 'bt');
                }
            } catch (e) { console.error("Mag Error", e); }
        }

        // 2. Fetch Plasma (Speed และ Density)
        async function fetchPlasma() {
            try {
                const res = await fetch('https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json');
                if (!res.ok) throw new Error('Network');
                const data = await res.json();
                if (data && data.length > 1) {
                    const last = data[data.length - 1];
                    
                    // Density is index 1
                    const density = parseFloat(last[1]);
                    updateStat('val-density', 'card-density', density, 'density');

                    // Speed is index 2
                    const speed = parseFloat(last[2]);
                    updateStat('val-wind', 'card-wind', speed, 'wind');
                }
            } catch (e) { console.error("Plasma Error", e); }
        }

        // 3. Fetch Dst
        async function fetchDst() {
            try {
                const res = await fetch('https://services.swpc.noaa.gov/products/kyoto-dst.json');
                if (!res.ok) throw new Error('Network');
                const data = await res.json();
                if (data && data.length > 1) {
                    const last = data[data.length - 1];
                    const dst = parseInt(last[1]); 
                    updateStat('val-dst', 'card-dst', dst, 'dst');
                }
            } catch (e) { console.error("Dst Error", e); }
        }

        // Logic การเปลี่ยนสี
        function updateStat(elemId, cardId, value, type) {
            const elem = document.getElementById(elemId);
            const card = document.getElementById(cardId);
            if (!elem || !card) return;

            elem.innerText = isNaN(value) ? "--" : value;
            card.className = 'stat-box'; 

            // เกณฑ์การเปลี่ยนสี (Thresholds)
            if (type === 'dst') {
                if (value < -50) card.classList.add('status-alert');
                else if (value < -20) card.classList.add('status-warn');
                else card.classList.add('status-normal');
            } 
            else if (type === 'bz') {
                if (value < -5) card.classList.add('status-alert'); // ยิ่งลบยิ่งแย่
                else if (value < 0) card.classList.add('status-warn');
                else card.classList.add('status-normal');
            } 
            else if (type === 'wind') {
                if (value > 600) card.classList.add('status-alert');
                else if (value > 400) card.classList.add('status-warn');
                else card.classList.add('status-normal');
            }
            else if (type === 'density') {
                if (value > 20) card.classList.add('status-alert'); // หนาแน่นเกิน 20 ไม่ดี
                else if (value > 10) card.classList.add('status-warn');
                else card.classList.add('status-normal');
            }
            else if (type === 'bt') {
                if (value > 20) card.classList.add('status-alert'); // สนามแม่เหล็กเข้มเกิน 20 คือแรง
                else if (value > 10) card.classList.add('status-warn');
                else card.classList.add('status-normal');
            }
        }

        function updateAll() {
            fetchMag(); fetchPlasma(); fetchDst();
            document.getElementById('updateTime').innerText = "Updated: " + new Date().toLocaleTimeString();
        }

        function refreshImages() {
            const images = document.querySelectorAll('img');
            const timestamp = new Date().getTime();
            images.forEach(img => {
                let src = img.src.split('?')[0];
                img.src = src + '?t=' + timestamp;
            });
        }

        updateAll();
        setInterval(updateAll, 60000); 
        setInterval(refreshImages, 300000); 
    </script>
</body>
</html>
