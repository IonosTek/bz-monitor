<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bz Monitor (Bz Dashboard)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* การตั้งค่าพื้นฐาน (Dark Theme) */
        body {
            background-color: #0b1026; /* สีน้ำเงินเข้มเหมือนท้องฟ้ากลางคืน */
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        h1 { text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .subtitle { color: #a0a0a0; font-size: 0.9rem; margin-bottom: 30px; }

        /* Grid Layout สำหรับการ์ดข้อมูล */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto 40px auto;
        }

        /* การ์ดแสดงผล */
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s;
        }
        
        .card:hover { transform: translateY(-5px); }

        .card h2 { font-size: 1.2rem; margin: 0 0 10px 0; color: #ccc; }
        .value { font-size: 3rem; font-weight: bold; }
        .unit { font-size: 1rem; color: #aaa; }

        /* สีสถานะ */
        .good-signal { color: #00ff9d; text-shadow: 0 0 10px #00ff9d; } /* สีเขียวสะท้อนแสง */
        .bad-signal { color: #ff4d4d; text-shadow: 0 0 10px #ff4d4d; } /* สีแดง */
        .neutral-signal { color: #ffffff; }

        /* ส่วนของกราฟ */
        .chart-container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
        }

        .footer { margin-top: 50px; font-size: 0.8rem; color: #555; }
    </style>
</head>
<body>

    <h1>Bz Monitor</h1>
    <div class="subtitle">Real-time Solar Wind Data from NOAA</div>

    <div class="dashboard-grid">
        <div class="card">
            <h2>Bz (Interplanetary Magnetic Field)</h2>
            <div id="bz-value" class="value">--</div>
            <span class="unit">nT (Nanotesla)</span>
            <p id="bz-status" style="font-size: 0.9rem; margin-top: 10px;">Waiting for data...</p>
        </div>

        <div class="card">
            <h2>Solar Wind Speed</h2>
            <div id="speed-value" class="value">--</div>
            <span class="unit">km/s</span>
        </div>

        <div class="card">
            <h2>Density</h2>
            <div id="density-value" class="value">--</div>
            <span class="unit">p/cm³</span>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="bzChart"></canvas>
    </div>

    <div class="footer">
        Data Source: NOAA Space Weather Prediction Center (DSCOVR Satellite)
    </div>

  <script>
        async function fetchData() {
            try {
                const response = await fetch('https://services.swpc.noaa.gov/products/geospace/propagated-solar-wind-1-hour.json');
                const data = await response.json();

                // --- จุดที่แก้ไข (FIX) ---
                // วนลูปย้อนหลังจากแถวสุดท้าย เพื่อหาแถวที่มีข้อมูลจริงๆ (ไม่เอาค่า null)
                let validRow = null;
                
                // data.length - 1 คือแถวสุดท้าย, วนไปเรื่อยๆ จนกว่าจะเจอ index 0
                for (let i = data.length - 1; i > 0; i--) {
                    // เช็คว่า column ที่ 6 (Bz) ต้องไม่เป็น null และต้องเป็นตัวเลข
                    const bzCheck = data[i][6];
                    if (bzCheck !== null && !isNaN(parseFloat(bzCheck))) {
                        validRow = data[i];
                        break; // เจอแล้วหยุดหาทันที
                    }
                }

                if (!validRow) {
                    throw new Error("No valid data found in the recent feed.");
                }
                // -------------------------

                // Mapping ข้อมูล (ใช้ validRow แทน latestData)
                // Index 1 = speed, 2 = density, 6 = bz
                const speed = parseFloat(validRow[1]);
                const density = parseFloat(validRow[2]);
                const bz = parseFloat(validRow[6]);

                updateDashboard(bz, speed, density);
                updateChart(data);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('bz-value').innerText = "ERR";
                document.getElementById('bz-status').innerText = "Data unavailable. Retrying...";
            }
        }

        function updateDashboard(bz, speed, density) {
            const bzElement = document.getElementById('bz-value');
            const bzStatus = document.getElementById('bz-status');
            
            // ปัดเศษทศนิยม 1 ตำแหน่งเพื่อให้ดูสะอาดตา
            bzElement.innerText = bz.toFixed(1);
            document.getElementById('speed-value').innerText = Math.round(speed); // ความเร็วลมปัดเป็นจำนวนเต็ม
            document.getElementById('density-value').innerText = density.toFixed(1);

            // ตรรกะสี
            // ลบค่า class เก่าออกก่อน
            bzElement.className = 'value';
            if (bz < 0) {
                bzElement.classList.add('good-signal');
            } else {
                bzElement.classList.add('bad-signal');
            }
            
            // ข้อความสถานะ
            if (bz <= -5) {
                bzStatus.innerHTML = "<span style='color:#00ff9d'>★ EXCELLENT! Strong Aurora likely.</span>";
            } else if (bz < 0) {
                bzStatus.innerHTML = "<span style='color:#aaffcc'>✓ GOOD. Favourable conditions.</span>";
            } else {
                bzStatus.innerHTML = "<span style='color:#ff4d4d'>✕ POOR. Magnetic field pointing North.</span>";
            }
        }

        let myChart = null;
        function updateChart(data) {
            // กรองเอาเฉพาะแถวที่มีข้อมูล Bz จริงๆ มาทำกราฟ
            const cleanData = data.slice(1).filter(row => row[6] !== null && !isNaN(parseFloat(row[6])));
            
            // เอา 60 จุดล่าสุด
            const recentData = cleanData.slice(-60); 
            
            const labels = recentData.map(row => row[0].substring(11, 16)); 
            const bzData = recentData.map(row => parseFloat(row[6]));

            const ctx = document.getElementById('bzChart').getContext('2d');

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Bz Trend',
                        data: bzData,
                        borderColor: '#ffffff',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                            gradient.addColorStop(0, 'rgba(0, 255, 157, 0.5)'); // สีเขียวจางๆ
                            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            grid: { color: '#333' },
                            ticks: { color: '#aaa' },
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#aaa', maxTicksLimit: 10 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        fetchData();
        setInterval(fetchData, 60000);
    </script>
